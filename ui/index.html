<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CV Agent – Extract • Edit • Export</title>
  <style>
    :root{ --primary:#0F62FE; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --bg:#fff }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg)}
    .wrap{max-width:1060px;margin:28px auto 80px;padding:0 16px}
    h1{font-size:22px;margin:0 0 8px}
    p{margin:0 0 12px;color:var(--muted)}
    .card{border:1px solid var(--line);background:#fff;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;font:inherit}
    textarea{min-height:90px}
    .btn{appearance:none;border:0;background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#1118270d;color:#111827}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .title{font-weight:700;margin:14px 0 6px}
    .subtle{color:var(--muted)}
    .list{display:grid;gap:12px}
    .item{border:1px dashed var(--line);border-radius:10px;padding:12px}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .log{background:#0b1020;color:#d1d5db;font:12px/1.45 ui-monospace,Menlo,Consolas;padding:12px;border-radius:8px;max-height:240px;overflow:auto}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .right{text-align:right}
  </style>
</head>
<body>
<div class="wrap">
  <h1>CV Agent</h1>
  <p>Upload a PPTX → extract & normalize (Azure OpenAI) → edit → export a Europass-style PDF.</p>

  <!-- Settings -->
  <div class="card">
    <div class="row">
      <div>
        <label>Function App Base URL</label>
        <input id="baseUrl" value="/" />
      </div>
      <div>
        <label>Host/Function Key (optional)</label>
        <input id="funcKey" placeholder="paste host key or function key"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>cvagent route</label>
        <input id="cvagentPath" value="api/cvagent"/>
      </div>
      <div>
        <label>Template (for server render – unused for client HTML)</label>
        <input id="tplName" value="cv_europass.html"/>
      </div>
    </div>
    <p class="subtle" style="margin-top:8px">
      If this page is served from the same Function App, base URL can be “/”. Otherwise use
      <code>https://&lt;app&gt;.azurewebsites.net/</code> and enable CORS.
    </p>
  </div>

  <!-- Step 1 -->
  <div class="card">
    <div class="title">1) Upload PPTX and extract</div>
    <div class="row">
      <div>
        <label>Select PPTX</label>
        <input type="file" id="pptxFile" accept=".pptx,.ppt,.ppsx,.potx,.potm,.pptm,.odp"/>
      </div>
      <div>
        <label>Output PDF file name</label>
        <input id="outName" value="cv-from-pptx.pdf"/>
      </div>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button class="btn" id="btnExtract">Extract → Normalize</button>
      <button class="btn secondary" id="btnLoadSample" type="button">Load sample CV</button>
    </div>
    <div id="extractLog" class="log" style="margin-top:10px; display:none"></div>
  </div>

  <!-- Step 2 -->
  <div class="card">
    <div class="title">2) Review & edit CV fields</div>
    <div class="row">
      <div><label>Full name</label><input id="pi_full_name"/></div>
      <div><label>Headline</label><input id="pi_headline"/></div>
    </div>
    <div class="row">
      <div><label>Address</label><input id="pi_address"/></div>
      <div><label>City</label><input id="pi_city"/></div>
    </div>
    <div class="row">
      <div><label>Country</label><input id="pi_country"/></div>
      <div><label>Email</label><input id="pi_email"/></div>
    </div>
    <div class="row">
      <div><label>Phone</label><input id="pi_phone"/></div>
      <div><label>Website</label><input id="pi_website"/></div>
    </div>
    <div class="row">
      <div><label>LinkedIn</label><input id="pi_linkedin"/></div>
      <div><label>Nationality</label><input id="pi_nationality"/></div>
    </div>
    <div class="row">
      <div><label>Date of Birth</label><input id="pi_dob"/></div>
      <div><label>Gender</label><input id="pi_gender"/></div>
    </div>

    <div class="title">Summary / About</div>
    <textarea id="cv_summary"></textarea>

    <div class="title" style="margin-top:14px">Skills groups <span class="subtle">(comma-separated items)</span></div>
    <div id="skillsList" class="list"></div>
    <div class="toolbar"><button class="btn secondary" type="button" id="addSkillGrp">+ Add group</button></div>

    <div class="title" style="margin-top:14px">Work experience</div>
    <div id="workList" class="list"></div>
    <div class="toolbar"><button class="btn secondary" type="button" id="addJob">+ Add job</button></div>

    <div class="title" style="margin-top:14px">Education</div>
    <div id="eduList" class="list"></div>
    <div class="toolbar"><button class="btn secondary" type="button" id="addEdu">+ Add education</button></div>

    <div class="title" style="margin-top:14px">Languages</div>
    <div id="langList" class="list"></div>
    <div class="toolbar"><button class="btn secondary" type="button" id="addLang">+ Add language</button></div>
  </div>

  <!-- Step 3 -->
  <div class="card">
    <div class="title">3) Export PDF</div>
    <div class="toolbar">
      <button class="btn" id="btnExport">Export PDF</button>
      <div id="exportStatus" class="subtle" style="margin-left:8px"></div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div>
        <div><span class="pill">Blob link</span></div>
        <div id="blobLink" style="margin-top:8px"></div>
      </div>
      <div class="right">
        <div><span class="pill">Local download</span></div>
        <div id="localLink" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="title">Logs</div>
    <pre class="log" id="log"></pre>
  </div>
</div>

<script>
  // ---------- helpers ----------
  const $ = id => document.getElementById(id);
  const logEl = $("log");
  const xlog = (...args) => {
    const s = args.map(a => typeof a === 'string' ? a : JSON.stringify(a,null,2)).join(' ');
    logEl.textContent += s + "\\n"; logEl.scrollTop = logEl.scrollHeight;
  };

  const EXT_RE = /\.(pptx|pptm|ppt|ppsx|potx|potm|odp)$/i;
  const toPdfName = n => (n || 'cv').replace(EXT_RE,'').replace(/\.+$/,'') + '.pdf';

  function baseUrl(){
    const v = $("baseUrl").value.trim();
    return v.endsWith("/") ? v : (v ? v + "/" : "/");
  }
  function withKey(url){
    const key = $("funcKey").value.trim();
    if (!key) return url;
    return url + (url.includes("?") ? "&" : "?") + "code=" + encodeURIComponent(key);
  }
  function apiUrlCvagent(){
    const path = $("cvagentPath").value.replace(/^\\/+/, "");
    return baseUrl() + path;
  }
  function apiUrlRenderHtml(){
    // hard path to the HTML renderer
    return baseUrl() + "api/renderpdf_html";
  }
  function jsonHeaders(){ return { "Content-Type": "application/json" }; }

  // ---------- UI builders ----------
  function el(tag, attrs={}, ...children){
    const e=document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k==="class") e.className=v;
      else if(k==="value") e.value=v;
      else e.setAttribute(k,v);
    }
    for(const c of children){
      if(typeof c==="string") e.appendChild(document.createTextNode(c));
      else if(c) e.appendChild(c);
    }
    return e;
  }

  function skillsItem(grp={group:"", items:[]}){
    const wrap = el('div',{class:'item'});
    const g = el('input',{value: grp.group||'', placeholder:'Group (e.g., Tech)'});
    const it = el('input',{value: (grp.items||[]).join(', '), placeholder:'Items (comma separated)'});
    wrap.append(el('label',{},'Group'), g, el('label',{},'Items'), it);
    wrap._get = () => ({ group:g.value.trim(), items: it.value.split(',').map(s=>s.trim()).filter(Boolean) });
    return wrap;
  }
  function jobItem(job={}){
    const wrap = el('div',{class:'item'});
    const title=el('input',{value:job.title||'', placeholder:'Title'});
    const company=el('input',{value:job.company||'', placeholder:'Company'});
    const location=el('input',{value:job.location||'', placeholder:'Location'});
    const sd=el('input',{value:job.start_date||'', placeholder:'Start'});
    const ed=el('input',{value:job.end_date||'', placeholder:'End or Present'});
    const desc=el('textarea',{placeholder:'Description'}); desc.value=job.description||'';
    const bullets=el('textarea',{placeholder:'Bullets (one per line)'}); bullets.value=(job.bullets||[]).join('\\n');
    wrap.append(
      el('label',{},'Title'),title,
      el('label',{},'Company'),company,
      el('label',{},'Location'),location,
      el('div',{class:'row'},
        el('div',{}, el('label',{},'Start'), sd),
        el('div',{}, el('label',{},'End'), ed)
      ),
      el('label',{},'Description'),desc,
      el('label',{},'Bullets'),bullets
    );
    wrap._get = () => ({
      title:title.value.trim(), company:company.value.trim(), location:location.value.trim(),
      start_date:sd.value.trim(), end_date:ed.value.trim(), description:desc.value.trim(),
      bullets: bullets.value.split('\\n').map(s=>s.trim()).filter(Boolean)
    });
    return wrap;
  }
  function eduItem(e={}){
    const wrap=el('div',{class:'item'});
    const degree=el('input',{value:e.degree||e.title||'', placeholder:'Degree / Title'});
    const inst=el('input',{value:e.institution||'', placeholder:'Institution'});
    const location=el('input',{value:e.location||'', placeholder:'Location'});
    const sd=el('input',{value:e.start_date||'', placeholder:'Start'});
    const ed=el('input',{value:e.end_date||'', placeholder:'End'});
    const details=el('textarea',{placeholder:'Details'}); details.value=e.details||'';
    wrap.append(
      el('label',{},'Degree / Title'),degree,
      el('label',{},'Institution'),inst,
      el('label',{},'Location'),location,
      el('div',{class:'row'},
        el('div',{}, el('label',{},'Start'), sd),
        el('div',{}, el('label',{},'End'), ed)
      ),
      el('label',{},'Details'),details
    );
    wrap._get = () => ({
      degree:degree.value.trim(), title:degree.value.trim(), institution:inst.value.trim(),
      location:location.value.trim(), start_date:sd.value.trim(), end_date:ed.value.trim(),
      details:details.value.trim()
    });
    return wrap;
  }
  function langItem(l={}){
    const wrap=el('div',{class:'item'});
    const name=el('input',{value:l.name||l.language||l.lang||'', placeholder:'Language'});
    const level=el('input',{value:l.level||'', placeholder:'Level (e.g., B2, C1)'});
    wrap.append(el('label',{},'Language'),name,el('label',{},'Level'),level);
    wrap._get = () => ({ name:name.value.trim(), level:level.value.trim() });
    return wrap;
  }

  // ---------- form state ----------
  let currentCV = { personal_info:{}, work_experience:[], education:[], skills_groups:[], languages:[], summary:"" };

  function fillForm(cv){
    currentCV = cv || currentCV;
    const pi=currentCV.personal_info||{};
    $("pi_full_name").value = pi.full_name||'';
    $("pi_headline").value  = pi.headline||'';
    $("pi_address").value   = pi.address||'';
    $("pi_city").value      = pi.city||'';
    $("pi_country").value   = pi.country||'';
    $("pi_email").value     = pi.email||'';
    $("pi_phone").value     = pi.phone||'';
    $("pi_website").value   = pi.website||'';
    $("pi_linkedin").value  = pi.linkedin||'';
    $("pi_nationality").value = pi.nationality||'';
    $("pi_dob").value         = pi.date_of_birth||'';
    $("pi_gender").value      = pi.gender||'';
    $("cv_summary").value     = currentCV.summary || currentCV.about || (pi.summary||'');

    $("skillsList").innerHTML=''; (currentCV.skills_groups||[]).forEach(g=>$("skillsList").appendChild(skillsItem(g)));
    $("workList").innerHTML=''; (currentCV.work_experience||[]).forEach(j=>$("workList").appendChild(jobItem(j)));
    $("eduList").innerHTML=''; (currentCV.education||[]).forEach(e=>$("eduList").appendChild(eduItem(e)));
    $("langList").innerHTML=''; (currentCV.languages||[]).forEach(l=>$("langList").appendChild(langItem(l)));
  }
  function collectCV(){
    const cv = {
      personal_info:{
        full_name:$("pi_full_name").value.trim(),
        headline:$("pi_headline").value.trim(),
        address:$("pi_address").value.trim(),
        city:$("pi_city").value.trim(),
        country:$("pi_country").value.trim(),
        email:$("pi_email").value.trim(),
        phone:$("pi_phone").value.trim(),
        website:$("pi_website").value.trim(),
        linkedin:$("pi_linkedin").value.trim(),
        nationality:$("pi_nationality").value.trim(),
        date_of_birth:$("pi_dob").value.trim(),
        gender:$("pi_gender").value.trim(),
        summary:$("cv_summary").value.trim()
      },
      summary:$("cv_summary").value.trim(),
      work_experience:[], education:[], skills_groups:[], languages:[]
    };
    for(const n of $("skillsList").children){ if(n._get) cv.skills_groups.push(n._get()); }
    for(const n of $("workList").children){ if(n._get) cv.work_experience.push(n._get()); }
    for(const n of $("eduList").children){ if(n._get) cv.education.push(n._get()); }
    for(const n of $("langList").children){ if(n._get) cv.languages.push(n._get()); }
    return cv;
  }

  // ---------- normalize (cvagent) ----------
  async function fileToBase64(file){
    return await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(String(r.result).split(',')[1]); r.onerror=rej; r.readAsDataURL(file); });
  }
  async function callCvAgentNormalizeOnly(file){
    const b64 = await fileToBase64(file);
    const payload = { pptx_base64:b64, pptx_name:file.name, mode:"normalize_only" };
    const url = withKey(apiUrlCvagent());
    const resp = await fetch(url, { method:'POST', headers: jsonHeaders(), body: JSON.stringify(payload) });
    const text = await resp.text(); let data; try{ data=JSON.parse(text);}catch{ data={raw:text}; }
    if(!resp.ok) throw new Error(text);
    xlog("cvagent normalize_only →", data);
    return (data.cv || data.normalized || data.result || data);
  }

  // ---------- client-side HTML generator for renderpdf_html ----------
  function htmlEscape(s){ return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

  function buildCss(){
    return `
      @page { size: A4; margin: 10mm }
      body { font-family: "DejaVu Sans", Arial, Helvetica, sans-serif; font-size: 12px; color: #111827; }
      h1 { font-size: 22px; margin: 0 0 6px; }
      h2 { font-size: 16px; border-bottom: 1px solid #e5e7eb; padding-bottom: 3px; margin: 14px 0 6px; }
      .muted { color: #6b7280; }
      .sec { margin-top: 8px; }
      .pill { display:inline-block; padding:3px 8px; border:1px solid #e5e7eb; border-radius:999px; margin:2px 4px; }
      ul { margin:6px 0 0 18px; }
    `;
  }

  function buildHtmlFromCv(cv){
    const pi = cv.personal_info || {};
    const contacts = [
      pi.email && {value:pi.email},
      pi.phone && {value:pi.phone},
      pi.website && {value:pi.website},
      pi.linkedin && {value:pi.linkedin},
      pi.city && {value:[pi.address, pi.city, pi.country].filter(Boolean).join(', ')},
    ].filter(Boolean);

    const skills = (cv.skills_groups || []).flatMap(g => (g.items||[]));

    const expHtml = (cv.work_experience||[]).map(e=>{
      const period = [e.start_date, e.end_date || "Present"].filter(Boolean).join(" – ");
      const bullets = (e.bullets||[]).map(b=>`<li>${htmlEscape(b)}</li>`).join("");
      return `
        <div class="sec">
          <strong>${htmlEscape(e.title||"")}</strong> — ${htmlEscape(e.company||"")}
          <div class="muted">${htmlEscape(period)}</div>
          ${e.location ? `<div class="muted">${htmlEscape(e.location)}</div>` : ""}
          ${e.description ? `<div>${htmlEscape(e.description)}</div>` : ""}
          ${bullets ? `<ul>${bullets}</ul>` : ""}
        </div>`;
    }).join("");

    const eduHtml = (cv.education||[]).map(ed=>{
      const period = [ed.start_date, ed.end_date].filter(Boolean).join(" – ");
      return `
        <div class="sec">
          <strong>${htmlEscape(ed.degree||ed.title||"")}</strong> — ${htmlEscape(ed.institution||"")}
          ${period ? `<div class="muted">${htmlEscape(period)}</div>` : ""}
          ${ed.location ? `<div class="muted">${htmlEscape(ed.location)}</div>` : ""}
          ${ed.details ? `<div>${htmlEscape(ed.details)}</div>` : ""}
        </div>`;
    }).join("");

    const langHtml = (cv.languages||[]).map(l=>{
      const label = [l.name||l.language||l.lang, l.level].filter(Boolean).join(" — ");
      return `<span class="pill">${htmlEscape(label)}</span>`;
    }).join("");

    const contactsHtml = contacts.map(c=>`<span class="pill">${htmlEscape(c.value)}</span>`).join("");
    const skillsHtml = skills.map(s=>`<span class="pill">${htmlEscape(s)}</span>`).join("");

    const summary = cv.summary || pi.summary || "";

    return `<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>${htmlEscape(pi.full_name || "Curriculum Vitae")}</title>
<style>${buildCss()}</style>
</head>
<body>
  <h1>${htmlEscape(pi.full_name || "")}</h1>
  <div class="muted">${htmlEscape(pi.headline || "")}</div>

  ${contactsHtml ? `<div class="sec">${contactsHtml}</div>` : ""}

  ${summary ? `<h2>Profile</h2><div>${htmlEscape(summary)}</div>` : ""}

  ${expHtml ? `<h2>Experience</h2>${expHtml}` : ""}

  ${eduHtml ? `<h2>Education</h2>${eduHtml}` : ""}

  ${skillsHtml ? `<h2>Skills</h2><div>${skillsHtml}</div>` : ""}

  ${langHtml ? `<h2>Languages</h2><div>${langHtml}</div>` : ""}
</body>
</html>`;
  }

  async function callRenderPdfHtml({ outName, html, css="" }){
    const url = withKey(apiUrlRenderHtml());
    const payload = { out_name: outName, html, css };
    const resp = await fetch(url, { method:'POST', headers: jsonHeaders(), body: JSON.stringify(payload) });
    const text = await resp.text(); let data; try{ data=JSON.parse(text);}catch{ data={raw:text}; }
    if(!resp.ok) throw new Error(data.error || text || "Export failed");
    if(!data.pdf_url) throw new Error("No pdf_url returned from renderpdf_html");
    return data.pdf_url;
  }

  function downloadFromUrlToFile(url, filename){
    fetch(url).then(r=>r.blob()).then(b=>{
      const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=filename||'cv.pdf'; a.click();
      URL.revokeObjectURL(a.href);
    });
  }

  // ---------- events ----------
  $("pptxFile").addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if (f) $("outName").value = toPdfName(f.name);
  });

  $("btnExtract").addEventListener('click', async ()=>{
    const f = $("pptxFile").files[0];
    if(!f){ alert('Choose a PPTX first'); return; }
    $("extractLog").style.display='block'; $("extractLog").textContent='Uploading and extracting...';
    try{
      const cv = await callCvAgentNormalizeOnly(f);
      fillForm(cv);
      $("extractLog").textContent = 'Extraction done. You can edit below.';
    }catch(err){
      $("extractLog").textContent = 'Error: ' + (err?.message || err);
      xlog("Extract error:", err?.message || err);
    }
  });

  $("btnLoadSample").addEventListener('click', ()=>{
    fillForm({
      personal_info:{ full_name:'Ada Lovelace', headline:'Computing Pioneer', city:'London', country:'UK', email:'ada@example.com', linkedin:'linkedin.com/in/ada' },
      summary:'Visionary mathematician; wrote the first algorithm intended to be carried out by a machine.',
      skills_groups:[{group:'Tech', items:['Analysis','Algorithms','Mathematics']}],
      work_experience:[{title:'Analyst', company:'Analytical Engine', start_date:'1842', end_date:'1852', bullets:['Translated Menabrea; extensive Notes','Conceptualized loop and subroutine']}],
      education:[{degree:'Self-taught Mathematics', institution:'Private tutelage', start_date:'1830', end_date:'1840'}],
      languages:[{name:'English', level:'Native'}]
    });
  });

  $("addSkillGrp").addEventListener('click', ()=> $("skillsList").appendChild(skillsItem({group:'',items:[]})));
  $("addJob").addEventListener('click', ()=> $("workList").appendChild(jobItem({})));
  $("addEdu").addEventListener('click', ()=> $("eduList").appendChild(eduItem({})));
  $("addLang").addEventListener('click', ()=> $("langList").appendChild(langItem({})));

  // EXPORT → build HTML on client and post to /api/renderpdf_html
  $("btnExport").addEventListener('click', async ()=>{
    const out = $("outName").value.trim() || 'cv.pdf';
    $("exportStatus").textContent = 'Rendering...';
    $("blobLink").textContent=''; $("localLink").textContent='';
    try{
      const cv = collectCV();
      const html = buildHtmlFromCv(cv);
      const css  = ""; // already inlined by buildHtmlFromCv(); keep blank

      const pdfUrl = await callRenderPdfHtml({ outName: out, html, css });
      $("exportStatus").textContent = 'Done.';
      $("blobLink").innerHTML = `<a href="${pdfUrl}" target="_blank" rel="noopener">Open PDF in Blob</a>`;

      const a=document.createElement('a'); a.href='#'; a.className='btn secondary'; a.textContent='Download locally';
      a.addEventListener('click', e=>{ e.preventDefault(); downloadFromUrlToFile(pdfUrl, out); });
      $("localLink").appendChild(a);
    }catch(err){
      $("exportStatus").textContent = 'Error';
      xlog("Export error:", err?.message || err);
      alert('Export error: ' + (err?.message || err));
    }
  });

  // Auto-fill base URL when hosted in Function App
  window.addEventListener('load', ()=>{
    try{
      if(location.hostname.endsWith('.azurewebsites.net')){
        $("baseUrl").value = location.origin + '/';
      }
    }catch{}
  });
</script>
</body>
</html>
