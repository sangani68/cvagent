<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CV Agent</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:20px;line-height:1.4}
    .card{max-width:920px;margin:0 auto;border:1px solid #e5e7eb;border-radius:12px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    h1{margin:0 0 12px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input[type=file],select,button,textarea{font:inherit}
    input[type=file],select,button{padding:8px 10px}
    button{border:1px solid #111827;border-radius:8px;background:#111827;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111827}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:#6b7280}
    textarea{width:100%;min-height:200px;border:1px solid #e5e7eb;border-radius:8px;padding:10px}
    .kv{display:grid;grid-template-columns:180px 1fr;gap:8px;align-items:center}
    .mt12{margin-top:12px}
    .mt20{margin-top:20px}
  </style>
</head>
<body>
  <div class="card">
    <h1>CV Agent</h1>

    <div class="kv">
      <label for="pptx">Source PPTX</label>
      <input id="pptx" type="file" accept=".ppt,.pptx"/>
      <div></div>
      <div class="muted">We’ll extract & normalize from your PPTX.</div>
    </div>

    <div class="kv mt12">
      <label for="templateName">Template</label>
      <select id="templateName">
        <option value="europass" selected>Europass (2-column)</option>
        <option value="kyndryl">Kyndryl (red sidebar)</option>
      </select>
      <div></div>
      <div class="muted">Kyndryl uses the same layout with red left column & white text.</div>
    </div>

    <div class="row mt12">
      <button id="btn-normalize">1) Extract & Normalize</button>
      <button id="btn-export" class="secondary" disabled>2) Export PDF</button>
    </div>

    <div class="mt20">
      <label>Normalized CV (preview / editable)</label>
      <textarea id="cv-json" spellcheck="false" placeholder='Normalized CV JSON will appear here...'></textarea>
    </div>

    <div class="mt12">
      <div>Output: <span id="out-link" class="muted">—</span></div>
    </div>

    <div id="preview" class="mt20" style="border:1px solid #e5e7eb;border-radius:8px;padding:12px;min-height:300px;overflow:auto"></div>
  </div>

  <script>
  const $ = (s) => document.querySelector(s);
  const $pptx = $("#pptx");
  const $tpl  = $("#templateName");
  const $btnN = $("#btn-normalize");
  const $btnE = $("#btn-export");
  const $txt  = $("#cv-json");
  const $out  = $("#out-link");
  const $prev = $("#preview");

  let sourceName = null;

  function toBase64(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result.split(",")[1]);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function safeJSON(text){
    try{ return JSON.parse(text) }catch(e){ return null }
  }

  function setBusy(b){ 
    $btnN.disabled = b; 
    $btnE.disabled = b || !$txt.value.trim(); 
  }

  // ------------------ Normalize ------------------
  $btnN.addEventListener("click", async () => {
    const f = $pptx.files && $pptx.files[0];
    if(!f){ alert("Please choose a PPTX file first."); return; }
    setBusy(true);
    try{
      sourceName = f.name;
      const b64 = await toBase64(f);
      const res = await fetch("/api/cvagent", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          pptx_base64: b64,
          pptx_name: sourceName,
          mode: "normalize_only"
        })
      });
      const data = await res.json();
      if(!res.ok){ throw new Error(data.error || "Normalize failed"); }
      const cv = data.cv || data.normalized || data;
      $txt.value = JSON.stringify(cv, null, 2);
      $btnE.disabled = false;
      $out.textContent = "—";
      $out.classList.add("muted");
      renderPreview();
    }catch(e){
      alert("Extract/Normalize error: " + e.message);
    }finally{
      setBusy(false);
    }
  });

  // ------------------ Export ------------------
  $btnE.addEventListener("click", async () => {
    const cv = safeJSON($txt.value);
    if(!cv){ alert("Invalid JSON in CV preview."); return; }
    const template = $tpl.value;
    setBusy(true);
    try{
      const res = await fetch("/api/cvagent", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          cv: cv,
          template: template,
          source_name: sourceName || "cv.pptx"
        })
      });
      const data = await res.json();
      if(!res.ok){ throw new Error(data.error || "Export failed"); }
      const url = data.pdf_url || (data.blob && data.blob.url) || data.url;
      if(!url){ throw new Error("No pdf_url returned by server"); }
      $out.innerHTML = `<a href="${url}" target="_blank" rel="noopener">Download PDF</a>`;
      $out.classList.remove("muted");
    }catch(e){
      alert("Export error: " + e.message);
    }finally{
      setBusy(false);
    }
  });

  // ------------------ Live preview ------------------
  $tpl.addEventListener("change", renderPreview);
  $txt.addEventListener("input", renderPreview);

  function tpl_europass(cv){
    return `<div class="eu-root" style="display:grid;grid-template-columns:320px 1fr;min-height:300px;font-family:sans-serif">
      <aside class="eu-side" style="background:#f8fafc;border-right:1px solid #e5e7eb;padding:22px">
        <div style="font-size:22px;font-weight:700">${cv.personal_info?.full_name||""}</div>
        <div style="font-size:13px;margin-top:4px">${cv.personal_info?.headline||""}</div>
      </aside>
      <main class="eu-main" style="padding:22px 26px;background:#fff;color:#0f172a">
        <h3>Summary</h3>
        <p>${cv.summary||""}</p>
      </main>
    </div>`;
  }

  // -------- Template Switch (Europass / Kyndryl) --------
  function renderTemplate(name, cv){
    const tplName = (name || "europass").toLowerCase();
    if(tplName === "kyndryl"){
      const htmlK = tpl_europass(cv)
        .replace(/background:#f8fafc/g, 'background:#c4122f;color:#fff;border-right:1px solid #a60f24')
        .replace(/color:#0f172a/g, 'color:#0f172a');
      return htmlK;
    }
    return tpl_europass(cv);
  }

  function renderPreview(){
    const cv = safeJSON($txt.value) || {};
    const tpl = $tpl.value;
    const html = renderTemplate(tpl, cv);
    $prev.innerHTML = html;
  }
  </script>
</body>
</html>
