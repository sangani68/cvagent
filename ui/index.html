<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CV Agent — Extract • Edit • Export</title>
<style>
  :root{ --brand:#0F62FE; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#fff; --side:#f8fafc; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
  .wrap{max-width:1140px;margin:28px auto 80px;padding:0 16px} h1{font-size:22px;margin:0 0 8px} p{margin:0 0 12px;color:var(--muted)}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
  textarea{min-height:90px}
  .btn{appearance:none;border:0;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#1118270d;color:#111827}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  .list{display:grid;gap:12px}
  .item{border:1px dashed var(--line);border-radius:10px;padding:12px}
  .log{background:#0b1020;color:#d1d5db;font:12px/1.5 ui-monospace,Menlo,Consolas;padding:12px;border-radius:8px;max-height:240px;overflow:auto;white-space:pre-wrap}
  #preview-frame{width:100%;height:900px;border:1px solid var(--line);border-radius:12px}
  details[open] summary{margin-bottom:8px}
  summary{cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>CV Agent</h1>
  <p>Upload PPTX → extract & normalize → edit → export a pixel-perfect PDF.</p>

  <!-- Settings -->
  <div class="card">
    <div class="row">
      <div><label>Function App Base URL</label><input id="baseUrl" value="/"/></div>
      <div><label>Host/Function Key (if required)</label><input id="funcKey" placeholder="paste key if authLevel=function"/></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>cvagent route</label><input id="cvagentPath" value="api/cvagent"/></div>
      <div><label>Template</label>
        <select id="templateName">
          <option value="europass" selected>Europass</option>
          <option value="kyndryl">Kyndryl (Red Sidebar)</option>
        </select>
      </div>
    </div>

    <details style="margin-top:10px">
      <summary><strong>Kyndryl options</strong> (optional)</summary>
      <div class="row">
        <div style="grid-column:1 / -1">
          <label>Kyndryl logo (data URL) — paste your <code>data:image/...;base64,....</code></label>
          <textarea id="kyndrylLogoData" placeholder="data:image/png;base64,iVBORw0K..."></textarea>
          <div style="color:#64748b;font-size:12px;margin-top:6px">
            If blank, the server uses the default online logo. Using a data URL is most reliable for PDF.
          </div>
        </div>
      </div>
    </details>

    <p style="color:#64748b;margin-top:8px">Same origin → keep Base URL “/”. If hosted elsewhere, use your Function URL with trailing slash.</p>
  </div>

  <!-- Step 1 -->
  <div class="card">
    <div style="font-weight:700;margin-bottom:8px">1) Upload PPTX and extract</div>
    <div class="row">
      <div>
        <label>Select PPTX</label>
        <input type="file" id="pptxFile" accept=".pptx,.ppt,.ppsx,.potx,.potm,.pptm,.odp"/>
      </div>
      <div>
        <label>Output PDF file name</label>
        <input id="outName" value="cv-europass.pdf"/>
      </div>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button class="btn" id="btnExtract">Extract → Normalize</button>
      <button class="btn secondary" id="btnLoadSample" type="button">Load sample CV</button>
    </div>
    <div id="extractLog" class="log" style="margin-top:10px;display:none"></div>
  </div>

  <!-- Step 2 -->
  <div class="card">
    <div style="font-weight:700;margin-bottom:8px">2) Review & edit CV fields</div>
    <div class="row">
      <div><label>Full name</label><input id="pi_full_name"/></div>
      <div><label>Headline</label><input id="pi_headline"/></div>
    </div>
    <div class="row">
      <div><label>Address</label><input id="pi_address"/></div>
      <div><label>City</label><input id="pi_city"/></div>
    </div>
    <div class="row">
      <div><label>Country</label><input id="pi_country"/></div>
      <div><label>Email</label><input id="pi_email"/></div>
    </div>
    <div class="row">
      <div><label>Phone</label><input id="pi_phone"/></div>
      <div><label>Website</label><input id="pi_website"/></div>
    </div>
    <div class="row">
      <div><label>LinkedIn</label><input id="pi_linkedin"/></div>
      <div><label>Nationality</label><input id="pi_nationality"/></div>
    </div>
    <div class="row">
      <div><label>Date of Birth</label><input id="pi_dob"/></div>
      <div><label>Gender</label><input id="pi_gender"/></div>
    </div>

    <div style="font-weight:700;margin-top:14px">Summary / About</div>
    <textarea id="cv_summary"></textarea>

    <div style="font-weight:700;margin-top:14px">Skills groups <span style="color:#64748b">(comma-separated items)</span></div>
    <div id="skillsList" class="list"></div>
    <div class="toolbar"><button class="btn secondary" type="button" id="addSkillGrp">+ Add group</button></div>

    <div style="font-weight:700;margin-top:14px">Work experience</div>
    <div id="workList" class="list"></div>
    <div class="toolbar"><button class="btn secondary" type="button" id="addJob">+ Add job</button></div>

    <div style="font-weight:700;margin-top:14px">Education</div>
    <div id="eduList" class="list"></div>
    <div class="toolbar"><button class="btn secondary" type="button" id="addEdu">+ Add education</button></div>

    <div style="font-weight:700;margin-top:14px">Languages</div>
    <div id="langList" class="list"></div>
    <div class="toolbar"><button class="btn secondary" type="button" id="addLang">+ Add language</button></div>
  </div>

  <!-- Step 3 -->
  <div class="card">
    <div style="font-weight:700;margin-bottom:8px">3) Preview (selected template)</div>
    <iframe id="preview-frame"></iframe>
    <div class="toolbar" style="margin-top:12px">
      <button class="btn secondary" id="btnRefreshPreview" type="button">Refresh preview</button>
    </div>
  </div>

  <!-- Step 4 -->
  <div class="card">
    <div style="font-weight:700;margin-bottom:8px">4) Export PDF</div>
    <div class="toolbar">
      <button class="btn" id="btnExport">Export PDF</button>
      <div id="exportStatus" style="margin-left:8px;color:#64748b"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
      <div>
        <div style="color:#64748b">Blob link</div>
        <div id="blobLink" style="margin-top:8px"></div>
      </div>
      <div style="text-align:right">
        <div style="color:#64748b">Local download</div>
        <div id="localLink" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:700;margin-bottom:8px">Logs</div>
    <pre class="log" id="log"></pre>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);
const jsonHeaders = () => ({ "Content-Type": "application/json" });
const EXT_RE = /\.(pptx|pptm|ppt|ppsx|potx|potm|odp|ppt)$/i;

const logEl = $("log");
const xlog = (...args) => { logEl.textContent += args.map(a => typeof a==='string'? a : JSON.stringify(a,null,2)).join(' ') + "\n"; logEl.scrollTop = logEl.scrollHeight; };

function buildBase(){ const v = $("baseUrl").value.trim() || "/"; return v.endsWith("/") ? v : v + "/"; }
function withKey(url){ const key = $("funcKey").value.trim(); return key ? url + (url.includes("?")?"&":"?") + "code=" + encodeURIComponent(key) : url; }
function cvagentUrl(){ const route = ($("cvagentPath").value || "api/cvagent").replace(/^\/+/, ""); return withKey(buildBase() + route); }

/* ---------- output filename logic ---------- */
let currentSourceName = null;
function baseName(name){
  if(!name) return "cv";
  const n = name.replace(/^.*[\\/]/,''); // strip path
  return n.replace(EXT_RE,'').replace(/\.+$/,'') || "cv";
}
function computeOutName(){
  const base = baseName(currentSourceName);
  const template = ($("templateName").value || "europass").toLowerCase();
  return `${base}-${template}.pdf`;
}
function updateOutName(){ $("outName").value = computeOutName(); }

/* ---------- UI builders ---------- */
function el(tag, attrs={}, ...children){
  const e=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){ if(k==="class") e.className=v; else if(k==="value") e.value=v; else e.setAttribute(k,v); }
  for(const c of children){ if(typeof c==="string") e.appendChild(document.createTextNode(c)); else if(c) e.appendChild(c); }
  return e;
}
function skillsItem(grp={group:"", items:[]}){ const w=el('div',{class:'item'});
  const g=el('input',{value:grp.group||'',placeholder:'Group (e.g., Tech)'}); const it=el('input',{value:(grp.items||[]).join(', '),placeholder:'Items (comma separated)'});
  w.append(el('label',{},'Group'),g,el('label',{},'Items'),it); w._get=()=>({group:g.value.trim(),items:it.value.split(',').map(s=>s.trim()).filter(Boolean)}); return w; }
function jobItem(j={}){ const w=el('div',{class:'item'}),t=el('input',{value:j.title||'',placeholder:'Title'}),c=el('input',{value=j.company||'',placeholder:'Company'}),l=el('input',{value:j.location||'',placeholder:'Location'}),sd=el('input',{value:j.start_date||'',placeholder:'Start'}),ed=el('input',{value:j.end_date||'',placeholder:'End/Present'}),d=el('textarea',{placeholder:'Description'}),b=el('textarea',{placeholder:'Bullets (one per line)'}); d.value=j.description||''; b.value=(j.bullets||[]).join('\n');
  w.append(el('label',{},'Title'),t,el('label',{},'Company'),c,el('label',{},'Location'),l,el('div',{class:'row'},el('div',{},el('label',{},'Start'),sd),el('div',{},el('label',{},'End'),ed)),el('label',{},'Description'),d,el('label',{},'Bullets'),b);
  w._get=()=>({title:t.value.trim(),company:c.value.trim(),location:l.value.trim(),start_date:sd.value.trim(),end_date:ed.value.trim(),description:d.value.trim(),bullets:b.value.split('\n').map(s=>s.trim()).filter(Boolean)}); return w; }
function eduItem(e={}){ const w=el('div',{class:'item'}),deg=el('input',{value:e.degree||e.title||'',placeholder:'Degree / Title'}),inst=el('input',{value:e.institution||'',placeholder:'Institution'}),l=el('input',{value:e.location||'',placeholder:'Location'}),sd=el('input',{value:e.start_date||'',placeholder:'Start'}),ed=el('input',{value:e.end_date||'',placeholder:'End'}),det=el('textarea',{placeholder:'Details'}); det.value=e.details||'';
  w.append(el('label',{},'Degree / Title'),deg,el('label',{},'Institution'),inst,el('label',{},'Location'),l,el('div',{class:'row'},el('div',{},el('label',{},'Start'),sd),el('div',{},el('label',{},'End'),ed)),el('label',{},'Details'),det);
  w._get=()=>({degree:deg.value.trim(),title:deg.value.trim(),institution:inst.value.trim(),location:l.value.trim(),start_date:sd.value.trim(),end_date:ed.value.trim(),details:det.value.trim()}); return w; }
function langItem(l={}){ const w=el('div',{class:'item'}),n=el('input',{value:l.name||l.language||l.lang||'',placeholder:'Language'}),lv=el('input',{value:l.level||'',placeholder:'Level (B2, C1)'}); w.append(el('label',{},'Language'),n,el('label',{},'Level'),lv); w._get=()=>({name:n.value.trim(),level:lv.value.trim()}); return w; }

/* ---------- form state ---------- */
let currentCV={ personal_info:{}, summary:"", skills_groups:[], work_experience:[], education:[], languages:[] };

function fillForm(cv){
  currentCV=cv||currentCV; const pi=currentCV.personal_info||{};
  $("pi_full_name").value=pi.full_name||''; $("pi_headline").value=pi.headline||'';
  $("pi_address").value=pi.address||''; $("pi_city").value=pi.city||''; $("pi_country").value=pi.country||'';
  $("pi_email").value=pi.email||''; $("pi_phone").value=pi.phone||''; $("pi_website").value=pi.website||'';
  $("pi_linkedin").value=pi.linkedin||''; $("pi_nationality").value=pi.nationality||''; $("pi_dob").value=pi.date_of_birth||''; $("pi_gender").value=pi.gender||'';
  $("cv_summary").value=currentCV.summary || pi.summary || '';

  $("skillsList").innerHTML=''; (currentCV.skills_groups||[]).forEach(g=>$("skillsList").appendChild(skillsItem(g)));
  $("workList").innerHTML=''; (currentCV.work_experience||[]).forEach(j=>$("workList").appendChild(jobItem(j)));
  $("eduList").innerHTML=''; (currentCV.education||[]).forEach(e=>$("eduList").appendChild(eduItem(e)));
  $("langList").innerHTML=''; (currentCV.languages||[]).forEach(l=>$("langList").appendChild(langItem(l)));

  refreshPreview();
}
function collectCV(){
  const cv={ personal_info:{
      full_name:$("pi_full_name").value.trim(), headline:$("pi_headline").value.trim(),
      address:$("pi_address").value.trim(), city:$("pi_city").value.trim(), country:$("pi_country").value.trim(),
      email:$("pi_email").value.trim(), phone:$("pi_phone").value.trim(), website:$("pi_website").value.trim(),
      linkedin:$("pi_linkedin").value.trim(), nationality:$("pi_nationality").value.trim(),
      date_of_birth:$("pi_dob").value.trim(), gender:$("pi_gender").value.trim(),
      summary:$("cv_summary").value.trim()
    },
    summary:$("cv_summary").value.trim(),
    skills_groups:[], work_experience:[], education:[], languages:[]
  };
  for(const n of $("skillsList").children) if(n._get) cv.skills_groups.push(n._get());
  for(const n of $("workList").children) if(n._get) cv.work_experience.push(n._get());
  for(const n of $("eduList").children) if(n._get) cv.education.push(n._get());
  for(const n of $("langList").children) if(n._get) cv.languages.push(n._get());
  return cv;
}

/* ---------- PDF-safe preview templates (table layout) ---------- */
function esc(s){return String(s??'').replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]))}
function asLangChips(langs){return (langs||[]).map(l=>esc([l.name||l.language||l.lang,l.level].filter(Boolean).join(" — ")))}

function euroLikeTemplate(cv, theme){
  const pi=cv.personal_info||{};
  const name=esc(pi.full_name||"");
  const role=esc(pi.headline||"");
  const location=esc([pi.city,pi.country].filter(Boolean).join(", "));
  const summary=esc(cv.summary||pi.summary||"");
  const languages=asLangChips(cv.languages||[]);
  const skills=(cv.skills_groups||[]).flatMap(g=>g.items||[]).map(s=>`<span class="chip">${esc(s)}</span>`).join("");
  const exp=(cv.work_experience||[]).map(e=>{
    const dates=esc((e.start_date||"") + " – " + (e.end_date||"Present"));
    const bullets=(e.bullets||[]).map(b=>`<li>${esc(b)}</li>`).join("");
    return `<div style="margin:10px 0 8px 0">
      <div><strong>${esc(e.title||"")}</strong> — ${esc(e.company||"")}</div>
      <div class="line2">${dates}${e.location?` • ${esc(e.location)}`:""}</div>
      ${e.description?`<div style="margin-top:6px">${esc(e.description)}</div>`:""}
      ${bullets?`<ul>${bullets}</ul>`:""}</div>`;
  }).join("");
  const edu=(cv.education||[]).map(ed=>{
    const dates=esc((ed.start_date||"") + (ed.end_date?` – ${ed.end_date}`:""));
    return `<div style="margin:10px 0 8px 0">
      <div><strong>${esc(ed.degree||ed.title||"")}</strong> — ${esc(ed.institution||"")}</div>
      <div class="line2">${dates}${ed.location?` • ${esc(ed.location)}`:""}</div>
      ${ed.details?`<div style="margin-top:6px">${esc(ed.details)}</div>`:""}</div>`;
  }).join("");

  const photo_b64 = pi.photo_base64 ? `data:image/png;base64,${esc(pi.photo_base64)}` : "";
  const logoData = (theme.useLogo && $("kyndrylLogoData").value.trim()) ? $("kyndrylLogoData").value.trim() : theme.logoUrl;

  return `<!doctype html><html><head><meta charset="utf-8"/>
  <style>
    @page { size:A4; margin:0 } body{margin:0;font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#0f172a}
    table.layout{width:100%;border-spacing:0;table-layout:fixed}
    td.side{width:32%;vertical-align:top;background:${theme.sideBg};color:${theme.sideFg};padding:18px 16px}
    td.main{width:68%;vertical-align:top;padding:20px 22px}
    h1{font-size:24px;margin:0 0 2px 0;color:${theme.nameColor}} .sub{color:${theme.titleColor};font-size:13px;margin:4px 0 12px}
    .sec{margin:14px 0 0} .sec h2{font-size:14px;margin:0 0 8px;text-transform:uppercase;letter-spacing:.06em;color:${theme.hColor}}
    .chip{display:inline-block;border-radius:999px;padding:3px 10px;margin:3px 6px 0 0;font-size:11px;border:1px solid ${theme.chipBorder};background:${theme.chipBg};color:${theme.chipFg}}
    .line2{color:#64748b;font-size:12px;margin:2px 0}
    ul{margin:6px 0 6px 18px;padding:0}
    .logo{width:110px}
    .photo{width:100px;height:100px;border-radius:50%;object-fit:cover}
    .hr{border:0;border-top:1px solid #e5e7eb;margin:12px 0}
  </style></head>
  <body>
  <table class="layout"><tr>
    <td class="side">
      ${photo_b64 ? `<div style="text-align:center;margin-bottom:10px"><img class="photo" src="${photo_b64}" alt="Profile"/></div>` : ``}
      <h1>${name}</h1>
      ${role?`<div class="sub">${role}</div>`:""}
      ${location?`<div class="sub" style="margin-top:0">${location}</div>`:""}
      ${languages.length?`<div class="sec"><h2>${theme.langLabel}</h2><ul style="list-style:none;margin-left:0">${languages.map(l=>`<li>${l}</li>`).join("")}</ul></div>`:""}
      ${theme.useLogo?`<div style="text-align:center;margin-top:16px"><img class="logo" src="${esc(logoData)}" alt="Logo"/></div>`:""}
    </td>
    <td class="main">
      ${summary?`<div class="sec"><h2>${theme.aboutLabel}</h2><div>${summary}</div></div><hr class="hr"/>`:""}
      ${exp?`<div class="sec"><h2>${theme.expLabel}</h2>${exp}</div>`:""}
      ${skills?`<div class="sec"><h2>${theme.skillsLabel}</h2><div>${skills}</div></div>`:""}
      ${edu?`<div class="sec"><h2>${theme.eduLabel}</h2>${edu}</div>`:""}
    </td>
  </tr></table>
  </body></html>`;
}

function tpl_europass(cv){
  const theme = {
    sideBg:"#F8FAFC", sideFg:"#0F172A", nameColor:"#0F172A", titleColor:"#475569", hColor:"#0F172A",
    chipBg:"#EEF2FF", chipFg:"#3730A3", chipBorder:"#E0E7FF",
    langLabel:"Languages", aboutLabel:"About Me", expLabel:"Work Experience", skillsLabel:"Skills", eduLabel:"Education & Training",
    useLogo:false, logoUrl:""
  };
  return euroLikeTemplate(cv, theme);
}
function tpl_kyndryl(cv){
  const theme = {
    sideBg:"#FF462D", sideFg:"#FFFFFF", nameColor:"#FFFFFF", titleColor:"#FFFFFF", hColor:"#FFFFFF",
    chipBg:"#FFFFFF", chipFg:"#FF462D", chipBorder:"#FFFFFF",
    langLabel:"LANGUAGES", aboutLabel:"ABOUT ME", expLabel:"PREVIOUS ROLES", skillsLabel:"SKILLS", eduLabel:"EDUCATION",
    useLogo:true, logoUrl:"https://upload.wikimedia.org/wikipedia/commons/7/73/Kyndryl_logo.svg"
  };
  return euroLikeTemplate(cv, theme);
}

/* preview router */
function renderTemplate(name, cv){
  switch((name||"europass").toLowerCase()){
    case "kyndryl": return tpl_kyndryl(cv);
    case "europass": default: return tpl_europass(cv);
  }
}
function refreshPreview(){ const html = renderTemplate($("templateName").value, collectCV()); $("preview-frame").srcdoc = html; }

function downloadFromUrlToFile(url, filename){
  fetch(url).then(r=>r.blob()).then(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=filename||'cv.pdf'; a.click(); URL.revokeObjectURL(a.href); });
}

/* ---------- EXTRACT ---------- */
async function fileToBase64(file){
  return await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(String(r.result).split(',')[1]); r.onerror=rej; r.readAsDataURL(file); });
}
async function callCvAgentNormalizeOnly(file){
  const dbg=$("extractLog"); dbg.style.display='block'; dbg.textContent='Preparing…';
  const b64=await fileToBase64(file); const kb=Math.round((b64.length*3/4)/1024);
  const payload={ pptx_base64:b64, pptx_name:file.name, mode:"normalize_only" };
  const url=cvagentUrl(); dbg.textContent=`POST ${url}\nfile: ${file.name} (~${kb} KB)`;
  let resp,text,data;
  try{ resp=await fetch(url,{method:'POST',headers:jsonHeaders(),body:JSON.stringify(payload)}); }
  catch(e){ dbg.textContent+=`\nNetwork error: ${e.message}`; throw new Error(`Network error calling cvagent: ${e.message}`); }
  text=await resp.text(); try{ data=JSON.parse(text);}catch{ data={raw:text}; }
  dbg.textContent+=`\nstatus: ${resp.status}`; if(!resp.ok){ const msg=(data&&(data.error||data.message))||text||`HTTP ${resp.status}`; dbg.textContent+=`\nerror: ${msg}`; throw new Error(msg); }
  dbg.textContent+=`\n✓ normalize_only OK`; return (data.cv||data.normalized||data.result||data);
}

/* ---------- EXPORT (via cvagent) ---------- */
async function exportViaCvAgent(){
  const cv=collectCV();
  const template=($("templateName").value||"europass").toLowerCase();
  const out=computeOutName(); // auto filename with template suffix

  const payload={ file_name: out, template, return:"url", cv };
  if(template==="kyndryl"){
    const logoData = $("kyndrylLogoData").value.trim();
    if(logoData){ payload.kyndryl_logo_data = logoData; }
  }
  const url=cvagentUrl();
  const res=await fetch(url,{method:'POST',headers:jsonHeaders(),body:JSON.stringify(payload)});
  const text=await res.text(); let data; try{ data=JSON.parse(text);}catch{ data={raw:text}; }
  if(!res.ok){ const msg=(data&&(data.error||data.message))||text||`HTTP ${res.status}`; throw new Error(`cvagent render failed: ${msg}`); }
  const pdfUrl=data.pdf_url||data.url||data.sas_url||data.link; if(!pdfUrl) throw new Error("No pdf_url returned by cvagent/render");
  return { pdfUrl, out };
}

/* ---------- events ---------- */
$("pptxFile").addEventListener('change', e=>{
  const f=e.target.files?.[0];
  if(f){ currentSourceName=f.name; updateOutName(); }
});

$("templateName").addEventListener('change', ()=>{
  updateOutName();
  refreshPreview();
});

$("btnExtract").addEventListener('click', async ()=>{
  const f=$("pptxFile").files[0]; if(!f){ alert('Choose a PPTX first'); return; }
  try{ const cv=await callCvAgentNormalizeOnly(f); fillForm(cv); $("extractLog").textContent += '\nDone. You can edit below.'; }
  catch(e){ alert('Extract error: '+(e.message||e)); }
});

$("btnLoadSample").addEventListener('click', ()=>{
  currentSourceName = null; // no file; will use cv-<template>.pdf
  updateOutName();
  fillForm({
    personal_info:{ full_name:'Ada Lovelace', headline:'Computing Pioneer', city:'London', country:'UK', email:'ada@example.com', linkedin:'linkedin.com/in/ada' },
    summary:'Visionary mathematician; wrote the first algorithm intended to be executed by a machine.',
    skills_groups:[{group:'Tech', items:['Analysis','Algorithms','Mathematics']}],
    work_experience:[{title:'Analyst', company:'Analytical Engine', start_date:'1842', end_date:'1852', location:'London', bullets:['Translated Menabrea','Conceived loop & subroutine']}],
    education:[{degree:'Mathematics', institution:'Private tutelage', start_date:'1830', end_date:'1840'}],
    languages:[{name:'English', level:'Native'}],
    achievements:['Pioneer work on algorithms'],
    certifications:['Royal Society lectures']
  });
});

$("addSkillGrp").addEventListener('click', ()=>$("skillsList").appendChild(skillsItem({group:'',items:[]})));
$("addJob").addEventListener('click', ()=>$("workList").appendChild(jobItem({})));
$("addEdu").addEventListener('click', ()=>$("eduList").appendChild(eduItem({})));
$("addLang").addEventListener('click', ()=>$("langList").appendChild(langItem({})));

$("btnRefreshPreview").addEventListener('click', refreshPreview);

$("btnExport").addEventListener('click', async ()=>{
  $("exportStatus").textContent='Rendering…'; $("blobLink").innerHTML=''; $("localLink").innerHTML='';
  try{
    const { pdfUrl, out } = await exportViaCvAgent();
    $("exportStatus").textContent='Done.';
    $("blobLink").innerHTML=`<a href="${pdfUrl}" target="_blank" rel="noopener">Open PDF in Blob</a>`;
    const a=document.createElement('a'); a.href='#'; a.className='btn secondary'; a.textContent='Download locally';
    a.addEventListener('click', e=>{ e.preventDefault(); downloadFromUrlToFile(pdfUrl, out); });
    $("localLink").appendChild(a);
  }catch(e){ $("exportStatus").textContent='Error'; alert(e.message||e); }
});

/* auto-fill base when hosted on the Function App */
window.addEventListener('load', ()=>{
  try{ if(location.hostname.endsWith('.azurewebsites.net')) $("baseUrl").value = location.origin + '/'; }catch{}
  updateOutName();
});
</script>
</body>
</html>
